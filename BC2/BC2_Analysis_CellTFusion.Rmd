
---
title: "NSCLC2"
author: "Francesco Massaini"
date: "2024-03-28"
output: html_document
editor_options: 
  chunk_output_type: inline
---

# Imports
```{r Imports}
suppressMessages(library(dplyr)) 
suppressMessages(library(tibble))
suppressMessages(library(tidyr))
suppressMessages(library(org.Hs.eg.db)) # Homo sapiens db
suppressMessages(library(stringr))
suppressMessages(library(RColorBrewer)) # for plot
suppressMessages(library(pheatmap)) # for heatmaps
suppressMessages(library(ADImpute)) # This package provides functions to compute TPM
suppressMessages(library(ggplot2))
suppressMessages(library(FactoMineR))
suppressMessages(library(factoextra))
suppressMessages(library(survival))
suppressMessages(library(ranger))
suppressMessages(library(ggfortify))
suppressMessages(library(rlang))
suppressMessages(library(purrr))
suppressMessages(library(rio))
suppressMessages(library(uwot))
suppressMessages(library(DESeq2))
```


# Functions
```{r Functions}
source("../Functions.R")
```

# Loading CellTFusion results
```{r Data loading}
# Load CellTFusion results
load("../../IMMUCAN_data/BC2/04_CellTFusion/CellTFusion_Subgroups_BC2.RData")
load("../../IMMUCAN_data/BC2/04_CellTFusion/CellTFusion_tfs_BC2.RData")
load("../../IMMUCAN_data/BC2/04_CellTFusion/CellTFusion_modules_deconv_BC2.RData")

deconv_subgroups = dt[["Deconvolution matrix"]]
TF_modules_deconv = as.data.frame(features_sig[[1]]) 
```

# Loading clinical data
```{r Loading Deconvolution}
# Load clinical data 
TPM = read.csv("/home/francesco.massaini/Desktop/IMMUCAN_data/BC2/02_TPM/BC2_fromAndreaRdata_filtered_Samples.csv", row.names = 1, check.names = FALSE)

clinical_all_columns = read.delim("/home/francesco.massaini/Desktop/IMMUCAN_data/BC2/01_Clinical_Data/BC2_clinical_export_20240602.tsv", sep = "\t") %>%
  dplyr::filter(immucan_sample_id %in% colnames(TPM)) %>%
  dplyr::select(where(~ sum(!is.na(.)) >= 20))

relevant_clinical_columns = c("immucan_patient_id",
      "immucan_sample_id",
      "surgery_days_after_diag",
      "sampling_days_after_diag",
      "lymphocyte_infiltration",
      "PCR",
      # "medical_review_end_point", # full of "pCR (e.g. surgery)". I'm not sure what is the difference with column PCR, perhaps on different time point?
      "residual_cancer_burden",
      "residual_disease",
      # "treatment_setting", # Empty column on the same samples of RNAseq
      # "sex", # obviously not so interesting for BC
      # "HER2_status", # all negative
      # "ER_status", # all negative
      # "PR_status", # only 1 patient positive
      "KI67_status",
      "laterality",
      # "disease_evolution", # only three 1 values
      "stage",
      "N_stage",
      # "M_stage", # only cM0 or unknown 
      "T_stage")

# Filter clinical with only relevant columns and mutate absent ("") values to NA
clinical = clinical_all_columns[, relevant_clinical_columns] %>%
  dplyr::select(-all_of(c("surgery_days_after_diag","sampling_days_after_diag", "immucan_patient_id"))) %>% # remove even immucan_patient_id for better further representations
  mutate(PCR = if_else(PCR == "", NA, PCR)) %>%
  mutate(stage = if_else(stage == "", NA, stage)) %>%
  mutate(lymphocyte_infiltration = if_else(lymphocyte_infiltration == "", NA, lymphocyte_infiltration)) %>%
  mutate(lymphocyte_infiltration = if_else(lymphocyte_infiltration == "Not Applicable", "Not applicable", lymphocyte_infiltration)) %>%
  mutate(residual_cancer_burden = if_else(residual_cancer_burden == "", NA, residual_cancer_burden)) %>%
  mutate(residual_disease = if_else(PCR == "", NA, residual_disease)) %>%
  column_to_rownames(var = "immucan_sample_id")

identical(rownames(clinical), rownames(deconv_subgroups))
```

# Preliminary Deconvolution Analisys ON DECONVOLUTION post CellTFusion subgrouping
## Sample Heatmap
NOTE: Expression df must be values as rows and patients as column. Clinical df must be patients as rows and feature as columns 
```{r, fig.width=10, fig.height=10, Heatmap}
  # Ensure same patients order

# Heatmap on TPM, groups and outliers 
# pdf(paste0(output_folder_TPM_outlier, "TPM_samples_heatmap.pdf"), width = 16, height = 16)
Compute_Samples_Heatmap(t(deconv_subgroups),  sample_feat_df = clinical, main_title = "Heatmap samples vs samples - Euclidian distance matrix on TPM data") 
# dev.off()

```

## Sample Dendrogram
```{r}
# Sample dendrograms, colored by relevant clinical feature
# pdf(paste0(output_folder_TPM_outlier, "TPM_samples_dendrogram.pdf"), width = 16, height = 10)
for (feat in colnames(clinical)){
  tree = Compute_Samples_dendrogram(t(deconv_subgroups),  sample_feat_df = clinical, feat_column = feat, main_title = "Sample dendrogram - Euclidian distance matrix on TPM data")
  print(tree)
}
# dev.off()
```

## PCA biplot
```{r}
# PCA biplot on TPM
clinical <- clinical %>% 
  mutate(across(everything(), ~ifelse(is.na(.), "NA", .))) #  quote NAs to show them in th plot 

# Compute PCA
pca_result <- FactoMineR::PCA(deconv_subgroups, scale.unit = TRUE, graph = FALSE)  
fviz_eig(pca_result) # Scree plot: explained variance by PC

# pdf(paste0(output_folder_TPM_outlier, "TPM_samples_PCA.pdf"))
for (feat in colnames(clinical)){
  p = factoextra::fviz_pca_biplot(pca_result, repel = T, select.var = list(contrib = 5), label = "var",
                              habillage = as.factor(clinical[,feat]),
                              addEllipses = T, ellipse.level=0.95, palette = "Dark2", 
                              legend.title = feat,
                              ggtheme = theme_minimal())
  print(p)
}
# repel = T do not overlap the text, select.var = list(contrib = 5) shows only the most 5 variable feature (variables) that contributes to separation. label = var , put label ONLY on the 5 variables
# dev.off()
```

## Umap 
```{r}
# UMAP on deconv post subgrouping
clinical <- clinical %>% 
  mutate(across(everything(), ~ifelse(. == "NA", NA, .))) # Restore NA 

umap_result <- as.data.frame(umap(deconv_subgroups, n_neighbors = 8, min_dist = 0.1, metric = "euclidean")) 
colnames(umap_result) <- c("UMAP1", "UMAP2")
umap_result = rownames_to_column(umap_result, var = "samples")
clinical_umap = rownames_to_column(clinical, var = "samples")
umap_result = left_join(umap_result, clinical_umap, by = "samples")

for (feat in colnames(clinical_umap)[-1]){
  col = c("UMAP1", "UMAP2", feat)
  umap_ggplot = dplyr::select(umap_result, all_of(col))
  colnames(umap_ggplot)[3] = "feat" 
  umap_plot <- ggplot(umap_ggplot, aes(x = UMAP1, y = UMAP2, color = feat)) +
    geom_point(size = 3) +
    labs(title = "UMAP of TPM Data", x = "UMAP1", y = "UMAP2") +
    theme_minimal() + 
    labs(color = feat)
    print(umap_plot)
}


```
# Correlation of deconvolution and IDA
```{r}
# Load MetaSample and MetaGene from BIODICA analysis. 
metasample_df <- read.table("/home/francesco.massaini/Projects/BIODICA/work/TPM_BC2_Biodica_meanDuplGenes_ICA/TPM_BC2_Biodica_meanDuplGenes_ica_A.xls", header = TRUE, row.names = 1)
metagene_df <- read.table("/home/francesco.massaini/Projects/BIODICA/work/TPM_BC2_Biodica_meanDuplGenes_ICA/TPM_BC2_Biodica_meanDuplGenes_ica_S.xls", header = TRUE, row.names = 1)

# Correlation
create_correlation_plot(data1 = deconv_subgroups, data2 = metasample_df, correlation_type = "pearson", r_threshold = 0.7, p_threshold = 0.05)


```



# Preliminary Deconvolution Analisys ON TF activity (modules) from CellTFusion 
## Sample Heatmap
NOTE: Expression df must be values as rows and patients as column. Clinical df must be patients as rows and feature as columns 
```{r, fig.width=10, fig.height=10, HeatmapTFmodules}
  # Ensure same patients order

# Heatmap on TPM, groups and outliers 
# pdf(paste0(output_folder_TPM_outlier, "TPM_samples_heatmap.pdf"), width = 16, height = 16)
Compute_Samples_Heatmap(t(tfs),  sample_feat_df = clinical, main_title = "Heatmap samples vs samples - Euclidian distance matrix on TPM data") 
# dev.off()

```


## Sample Dendrogram
```{r}
# Sample dendrograms, colored by relevant clinical feature
# pdf(paste0(output_folder_TPM_outlier, "TPM_samples_dendrogram.pdf"), width = 16, height = 10)
for (feat in colnames(clinical)){
  tree = Compute_Samples_dendrogram(t(tfs),  sample_feat_df = clinical, feat_column = feat, main_title = "Sample dendrogram - Euclidian distance matrix on TPM data")
  print(tree)
}
# dev.off()
```


## PCA biplot
```{r}
# PCA biplot on TPM
clinical <- clinical %>% 
  mutate(across(everything(), ~ifelse(is.na(.), "NA", .))) #  quote NAs to show them in th plot 

# Compute PCA
pca_result <- FactoMineR::PCA(tfs, scale.unit = TRUE, graph = FALSE)  
fviz_eig(pca_result) # Scree plot: explained variance by PC

# pdf(paste0(output_folder_TPM_outlier, "TPM_samples_PCA.pdf"))
for (feat in colnames(clinical)){
  p = factoextra::fviz_pca_biplot(pca_result, repel = T, select.var = list(contrib = 5), label = "var",
                              habillage = as.factor(clinical[,feat]),
                              addEllipses = T, ellipse.level=0.95, palette = "Dark2", 
                              legend.title = feat,
                              ggtheme = theme_minimal())
  print(p)
}
# repel = T do not overlap the text, select.var = list(contrib = 5) shows only the most 5 variable feature (variables) that contributes to separation. label = var , put label ONLY on the 5 variables
# dev.off()
```
## Umap 
```{r}
# UMAP on TPM
clinical <- clinical %>% 
  mutate(across(everything(), ~ifelse(. == "NA", NA, .))) # Restore NA 

umap_result <- as.data.frame(umap(tfs, n_neighbors = 8, min_dist = 0.1, metric = "euclidean")) 
colnames(umap_result) <- c("UMAP1", "UMAP2")
umap_result = rownames_to_column(umap_result, var = "samples")
clinical_umap = rownames_to_column(clinical, var = "samples")
umap_result = left_join(umap_result, clinical_umap, by = "samples")

for (feat in colnames(clinical_umap)[-1]){
  col = c("UMAP1", "UMAP2", feat)
  umap_ggplot = dplyr::select(umap_result, all_of(col))
  colnames(umap_ggplot)[3] = "feat" 
  umap_plot <- ggplot(umap_ggplot, aes(x = UMAP1, y = UMAP2, color = feat)) +
    geom_point(size = 3) +
    labs(title = "UMAP of TPM Data", x = "UMAP1", y = "UMAP2") +
    theme_minimal() + 
    labs(color = feat)
    print(umap_plot)
}


```

# Correlation of deconvolution and IDA
```{r}
# Load MetaSample and MetaGene from BIODICA analysis. 
metasample_df <- read.table("/home/francesco.massaini/Projects/BIODICA/work/TPM_BC2_Biodica_meanDuplGenes_ICA/TPM_BC2_Biodica_meanDuplGenes_ica_A.xls", header = TRUE, row.names = 1)
metagene_df <- read.table("/home/francesco.massaini/Projects/BIODICA/work/TPM_BC2_Biodica_meanDuplGenes_ICA/TPM_BC2_Biodica_meanDuplGenes_ica_S.xls", header = TRUE, row.names = 1)

# Correlation
create_correlation_plot(data1 = tfs, data2 = metasample_df, correlation_type = "pearson", r_threshold = 0.7, p_threshold = 0.05)


```



