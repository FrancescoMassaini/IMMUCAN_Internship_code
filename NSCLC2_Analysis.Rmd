
---
title: "NSCLC2"
author: "Francesco Massaini"
date: "2024-03-28"
output: html_document
---

# Imports
```{r Imports}
suppressMessages(library(dplyr)) 
suppressMessages(library(tibble))
suppressMessages(library(tidyr))
suppressMessages(library(org.Hs.eg.db)) # Homo sapiens db
suppressMessages(library(stringr))
suppressMessages(library(RColorBrewer)) # for plot
suppressMessages(library(pheatmap)) # for heatmaps
suppressMessages(library(ADImpute)) # This package provides functions to compute TPM
suppressMessages(library(ggplot2))
suppressMessages(library(FactoMineR))
suppressMessages(library(factoextra))
suppressMessages(library(survival))
suppressMessages(library(ranger))
suppressMessages(library(ggfortify))
suppressMessages(library(rlang))
suppressMessages(library(purrr))
suppressMessages(library(rio))
```


# Functions
```{r Functions}
source("./Functions.R")
```

# Path and folders
```{r Data loading}
# Imposta il percorso della cartella
input_folder <- "../IMMUCAN_data/NSCLC2/01_Raw_Counts/star_counts"
output_folder_TPM <- "../IMMUCAN_data/NSCLC2/02_TPM/"
output_folder_TPM_outlier <- "../IMMUCAN_data/NSCLC2/02_Plot_Outliers/"
output_folder_deconvolution <- "../IMMUCAN_data/NSCLC2/03_Deconvolution/Whitout_CD226_and_without_patient3/"
output_folder_CellTFusion <- "../IMMUCAN_data/NSCLC2/04_CellTFusion/Whitout_CD226_and_without_patient3/" 



# Ottieni tutti i file .txt nella cartella
txt_input_files <- list.files(path = input_folder, pattern = "\\.txt$", full.names = TRUE)

# Stampa il contenuto della variabile txt_files
# print(txt_input_files)

files_names <- gsub(".txt$", "", basename(txt_input_files))
samples_names = str_split_i(files_names, "_", 1)

```

# load and processing data NSCLC2
```{r Processing Raw Counts}

# Merging all the patients files, filtering rows of input files, removing gene version, and converting to GENE SYMBOLS

merged_counts <- read.delim(txt_input_files[1], header = 0, row.names = 1)
colnames(merged_counts) <- samples_names[1]

colSums(merged_counts) # Not yet normalized to TPM

for (i in 2:length(txt_input_files)) {
    # Leggi il data frame successivo
  counts <- read.delim(txt_input_files[i], header = 0, row.names = 1)
  colnames(counts) <- samples_names[i]
  # Unisci le colonne del nuovo data frame a merged_counts
  merged_counts <- cbind(merged_counts, counts)
}

merged_counts <- merged_counts %>%
  filter(!rownames(.) %in% c("__no_feature", "__ambiguous", "__too_low_aQual", "__not_aligned", "__alignment_not_unique")) %>%
  remove_gene_version() %>%
  EnsemblID_to_GeneSymbol()

# ADImpute to normalize to TPM
TPM <- counts_to_TPM(merged_counts)
# write.table(TPM, "../IMMUCAN_data/NSCLC2/02_TPM/NSCLC2_TPM.txt")
```

# Analizing TPM
```{r Distribution}
# Summary and check TPM
summary(TPM)
colSums(TPM) # NOTE, this doesn't sum up to 1 million anymore because when you convert ENSEMBL IDs to GENE SYMBOLS some genes are lost because of duplicates names

TPM_with_genes <- TPM %>%
  rownames_to_column(var = "Gene")

TPM_long <- pivot_longer(TPM_with_genes, 
                         cols = -Gene,
                         names_to = "Patient",
                         values_to = "TPM") 

ggplot(TPM_long, aes(x = log1p(TPM)))+
  geom_density()+ theme_bw() +
  labs(title = "log(TPM+1) Distribution", 
       x = "log(TPM + 1)", 
       y = "Density")
```

# TPM Analysis
```{r Heatmap and dendrogram}
# Heatmap and dendrogram to see patient outliers on TPM

pdf(paste0(output_folder_TPM_outlier, "TPM_samples_heatmap.pdf"), width = 16, height = 16)
Compute_Samples_Heatmap(TPM, main_title = "Sample heatmap", sub_title = "distance matrix on TPM data")
dev.off()


pdf(paste0(output_folder_TPM_outlier, "TPM_samples_dendrogram.pdf"), width = 16, height = 10)
Compute_Samples_dendrogram(TPM)
dev.off()


# PCA biplot on TPM

pca_result <- PCA(t(TPM), scale.unit = TRUE, graph = FALSE) # t(BC2) because PCA takes rows 
fviz_eig(pca_result)

pdf(paste0(output_folder_TPM_outlier, "TPM_samples_PCA.pdf"))
factoextra::fviz_pca_biplot(pca_result, repel = T, select.var = list(contrib = 5), label = "var") # repel = T do not overlap the text, select.var = list(contrib = 5) shows only the most 5 variable feature (variables) that contributes to separation. label = var , put label ONLY on the 5 variables
dev.off()
```

# Loading Deconvolution Data
```{r Loading Deconvolution}
# Deconvoltion Data Loading
input_folder_deconvolution <- "/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/03_Deconvolution/Whitout_CD226_and_without_patient3/"
output_folder_deconvolution <- "/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/03_Deconvolution/Whitout_CD226_and_without_patient3/"
txt_input_files_deconvolution <- c("/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/03_Deconvolution/Whitout_CD226_and_without_patient3/all_deconvolutions_NSCLC2_TPM_withoutCD226_withoutPatient3.txt")
files_names_deconvolution <- gsub(".txt$", "", basename(txt_input_files_deconvolution))

deconv <- read.table(txt_input_files_deconvolution, header = TRUE,  sep = '	', row.names = 1)

```

# Preliminary Deconvolution Analisys ON DECONVOLUTION DATA
```{r Deconvolution}
# Sample clustering
# pdf(paste0(output_folder_deconvolution, files_names_deconvolution, "_deconvolution_samples_heatmap.pdf"), width = 2000, height = 2000)
png(paste0(output_folder_deconvolution, files_names_deconvolution, "_deconvolution_samples_heatmap.png"), width = 2000, height = 2000)
Compute_Samples_Heatmap(t(deconv)) # double t() (here and in the function) to take into account rows
dev.off()
# dev.off()

# pdf(paste0(output_folder_deconvolution, files_names_deconvolution, "_deconvolution_samples_clustering.pdf"), width = 2000, height = 2000)
png(paste0(output_folder_deconvolution, files_names_deconvolution, "_deconvolution_samples_clustering.png"), width = 2000, height = 1000)
Compute_Samples_dendrogram(t(deconv))
dev.off()
# dev.off()

# PCA
pca_result <- PCA(deconv, scale.unit = TRUE, graph = FALSE) # t(deconv) because PCA takes rows 
fviz_eig(pca_result)

# pdf(paste0(output_folder_deconvolution, "deconvolution_samples_PCA.pdf"))
png(paste0(output_folder_deconvolution, "deconvolution_samples_PCA.png"))
factoextra::fviz_pca_biplot(pca_result, repel = T, select.var = list(contrib = 5), label = "var") # repel = T do not overlap the text, select.var = list(contrib = 5) shows only the most 5 variable feature (variables) that contributes to separation. label = var , put label ONLY on the 5 variables
dev.off()
# dev.off()

```

# Benchmark of deconvolution results vs mIF data
```{r Correlation Deconv vs mIF}
# loading mIF FRACTION files and using the same patient names convention.  
IF1 <- read.csv("/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/01_IF_IMC/IF1_cell_type_fraction.csv", header = 1, row.names = 1)
rownames(IF1) <- rownames(IF1) %>% 
  str_remove_all("-IF1-01")

IF2 <- read.csv("/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/01_IF_IMC/IF2_cell_type_fraction.csv", header = 1, row.names = 1)
rownames(IF2) <- rownames(IF2) %>% 
  str_remove_all("-IF2-01")

IF3 <- read.csv("/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/01_IF_IMC/IF3_cell_type_fraction.csv", header = 1, row.names = 1)
rownames(IF3) <- rownames(IF3) %>% 
  str_remove_all("-IF3-01")

# Keeping only common patients and saving the file
common_patients <- Reduce(intersect, list(rownames(IF1), rownames(IF2), rownames(IF3))) # Redcue beacuse to apply intersect on more sets, you should reduce the common intersection progressively
IFs <- cbind(IF1[common_patients,], IF2[common_patients,], IF3[common_patients,])

# write.csv(IFs, "/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/01_IF_IMC/all_IFs_cell_type_fraction.csv")


# Computing correlation between Deconvolution features and imaging
corr_method <- "spearman"
imaging <- "mIFs"
Deconv <- "Deconv"
p_value_threshold <- 0.05 
low_corr <- -0.5
high_corr <- 0.5

corr_results <- compute_correlation(deconv_path = "/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/03_Deconvolution/Whitout_CD226_and_without_patient3/all_deconvolutions_NSCLC2_TPM_withoutCD226_withoutPatient3.txt",
                         imaging_path = "/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/01_IF_IMC/all_IFs_cell_type_fraction.csv",
                         imaging_pattern_to_remove = "",
                         deconv_pattern_to_remove = "-RNA-01|-RNA-02|-RNA-04",
                         significance_level = p_value_threshold,
                         low_corr_threshold = low_corr,
                         high_corr_threshold = high_corr,
                         cor_type = corr_method,
                         imaging_type = imaging,
                         deconv_type = Deconv)

plot_correlation_matrix(high_corr_pairs = corr_results[[1]],
                        cor_type = corr_method,
                        file_name = paste(Deconv, "vs_all_", imaging, sep = "_"),
                        output_folder = output_folder_deconvolution,
                        save_png = T,
                        x_label = imaging,
                        y_label = Deconv, 
                        png_width = 20,
                        png_height = 20,
                        significance_level = p_value_threshold,
                        high_corr_threshold = high_corr,
                        low_corr_threshold = low_corr)

pdf(file = paste0(output_folder_deconvolution,"scatterplot_", Deconv, "_vs_", imaging, ".pdf"))
for (i in 1:nrow(corr_results[[1]])){
  if (i %% 2 == 1) {
    par(mfrow=c(2,1))
  }
  
  x = dplyr::select(corr_results[[6]], corr_results[[1]][i,"Feature1"]) 
  y = dplyr::select(corr_results[[6]], corr_results[[1]][i,"Feature2"]) 

  plot(x[,1], y[,1], main = "Scatter Plot", xlab = corr_results[[1]][i,"Feature1"], ylab = corr_results[[1]][i,"Feature2"])

  # Calcola il modello di regressione lineare
  model <- lm(y[,1] ~ x[,1])
  r = summary(model)$r.squared
  
  # Aggiungi la linea di regressione al plot
  abline(model, col = "red")
  text(x = max(x) * 0.7, y = max(y), labels = paste("R^2 =", round(r, 2)), col = "red")
  
  if (i == nrow(corr_results[[1]]) && i %% 2 == 1) {
    dev.off()
  }
}
dev.off()


# Apri il dispositivo PDF
pdf(file = paste0(output_folder_deconvolution, "scatterplot_", Deconv, "_vs_", imaging, ".pdf"))

for (i in 1:nrow(corr_results[[1]])) {
  # Imposta due plot per pagina
  if (i %% 2 == 1 || nrow(corr_results[[1]]) == 1) {  # Apre una nuova pagina se i è dispari o c'è solo un plot
    par(mfrow=c(2, 1))
  }

  # Seleziona i dati per il plot
  x <- dplyr::select(corr_results[[6]], corr_results[[1]][i, "Feature1"]) 
  y <- dplyr::select(corr_results[[6]], corr_results[[1]][i, "Feature2"]) 

  # Calcola il modello di regressione lineare e aggiungi la linea di regressione
  model <- lm(y[, 1] ~ x[, 1])
  # Calcola R^2 e aggiungi il testo al plot
  r <- summary(model)$r.squared
  # Crea il plot
  plot(x[, 1], y[, 1], 
       main = "Scatter Plot",
       xlab = corr_results[[1]][i, "Feature1"], 
       ylab = corr_results[[1]][i, "Feature2"], 
       cex.lab = 0.75)
  
  abline(model, col = "red")
  mtext(paste("R^2:", round(r, 2)), side = 3, line = 0.5, adj = 0)
  # Non chiudere il dispositivo dopo ogni plot
}

# Chiudi il dispositivo PDF dopo che tutti i plot sono stati generati
dev.off()

```

# Benchmark of deconvolution results vs IMC data
```{r Correlation Deconv vs IMC}
# Computing correlation between Deconvolution features and imaging
corr_method <- "spearman"
imaging = "IMC"
Deconv = "Deconv"
p_value_threshold <- 0.05 
low_corr <- -0.5
high_corr <- 0.5

corr_results <- compute_correlation(deconv_path = "/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/03_Deconvolution/Whitout_CD226_and_without_patient3/all_deconvolutions_NSCLC2_TPM_withoutCD226_withoutPatient3.txt",
                         deconv_low_value_filter = F,
                                    imaging_path = "/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/01_IF_IMC/IMC_cell_type_densities.csv",
                         imaging_pattern_to_remove = "",
                         deconv_pattern_to_remove = "-RNA-01|-RNA-02|-RNA-04|-FIXT-01",
                         significance_level = p_value_threshold,
                         low_corr_threshold = low_corr,
                         high_corr_threshold = high_corr,
                         cor_type = corr_method,
                         imaging_type = imaging,
                         deconv_type = Deconv)

plot_correlation_matrix(high_corr_pairs = corr_results[[1]],
                        cor_type = corr_method,
                        file_name = paste(Deconv, "vs", imaging, sep = "_"),
                        output_folder = output_folder_deconvolution,
                        save_png = F,
                        x_label = imaging,
                        y_label = Deconv, 
                        significance_level = p_value_threshold,
                        high_corr_threshold = high_corr,
                        low_corr_threshold = low_corr)

# Scatter plot 
pdf(file = paste0(output_folder_deconvolution, "scatterplot_", Deconv, "_vs_", imaging, ".pdf"))

for (i in 1:nrow(corr_results[[1]])) {
  # Imposta due plot per pagina
  if (i %% 2 == 1 || nrow(corr_results[[1]]) == 1) {  # Apre una nuova pagina se i è dispari o c'è solo un plot
    par(mfrow=c(2, 1))
  }

  # Seleziona i dati per il plot
  x <- dplyr::select(corr_results[[6]], corr_results[[1]][i, "Feature1"]) 
  y <- dplyr::select(corr_results[[6]], corr_results[[1]][i, "Feature2"]) 

  # Calcola il modello di regressione lineare e aggiungi la linea di regressione
  model <- lm(y[, 1] ~ x[, 1])
  # Calcola R^2 e aggiungi il testo al plot
  r <- summary(model)$r.squared
  # Crea il plot
  plot(x[, 1], y[, 1], 
       main = "Scatter Plot",
       xlab = corr_results[[1]][i, "Feature1"], 
       ylab = corr_results[[1]][i, "Feature2"], 
       cex.lab = 0.75)
  
  abline(model, col = "red")
  # mtext(paste("R^2:", round(r, 2)), side = 3, line = 0.5, adj = 0)
  # Non chiudere il dispositivo dopo ogni plot
}
# Chiudi il dispositivo PDF dopo che tutti i plot sono stati generati
dev.off()


```


# Deconvolution results of BPRNACan3DProMet_M2 vs ALL clinical data 
```{r BPRNACan3DProMet_M2}
# loading clinical file and using the same patient names convention for IF and deconvlution results. Deleting also Tumor counts from IF data  
clinical <- read.csv("/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/01_Clinical_Data/Daniel/NSCLC2_for_R_update_2024.csv", header = 1) %>%
  column_to_rownames(var = "immucan_id")
  
rownames(deconv) <- rownames(deconv) %>%
  str_remove_all(pattern = "-FIXT-01|-RNA-01|-RNA-02||-RNA-04")

# Keeping only common patients and subsetting deconv and IF 
common_patients <- intersect(rownames(clinical), rownames(deconv))
clinical_common <- clinical[common_patients,] %>%
  dplyr::select(death, gender, stage, side_localization, smoking_status, neo_adjuvant_treatment, adjuvant_treatment, type_of_adj_trt, metastatic_treatment, simple_histology, simple_stage, primary_localization, long_survivors, T_stage, M_stage, N_stage, primary_tumor_size, TIL_score)
deconv_common <- deconv[common_patients, ] # %>%
  # dplyr::select(grep("*._BPRNACan3DProMet_M2|CBSX_LM22_Macrophages_M2", colnames(deconv)))


merged_df_clinical <- cbind(clinical_common, deconv_common)
merged_df_clinical[1:18] <- lapply(merged_df_clinical[1:18], factor)

for (i in colnames(merged_df_clinical)[19:ncol(merged_df_clinical)]) {
  for (j in colnames(merged_df_clinical)[1:18]) {
    if (is.factor(merged_df_clinical[[j]]) && is.numeric(merged_df_clinical[[i]])) {
      data_no_na <- na.omit(merged_df_clinical[, c(i, j)])
      
      if (length(unique(data_no_na[[j]])) > 2) {
        # ANOVA
        formula <- as.formula(paste(i, "~", j))
        test_result <- aov(formula, data = data_no_na)
        summary_result <- summary(test_result)
        p_value <- round(summary_result[[1]]$'Pr(>F)'[1], digit = 3)
      } else {
        # Test t
        formula <- as.formula(paste(i, "~", j))
        test_result <- t.test(formula, data = data_no_na)
        p_value <- round(test_result$p.value, digit = 3)
      }
      
      # Grafico
      plot <- ggplot(data_no_na, aes_string(x = j, y = i, fill = j)) +
        geom_violin() +
        labs(title = paste("Violin plot of", i, "by", j), subtitle = paste("p-value:", p_value)) +
        theme(axis.text.x = element_text(angle = 90))
      
      
      
       if(p_value<0.08) print(plot)
    }
  }
}


clinical_common2 <- clinical[common_patients,] %>%
  dplyr::select(death, time_to_event, age_at_registration, age_at_diagnosis, average_number_of_cigarettes, number_of_years, tumor_area_mm_square)
merged_df_clinical2 <- cbind(clinical_common2, deconv_common)

merged_df_clinical2 = mutate(merged_df_clinical2, death = ifelse(death == "Yes", 1, 0))
merged_df_clinical2 = mutate(merged_df_clinical2, M2_Epidish = ifelse(Epidish_BPRNACan3DProMet_M2 > median(Epidish_BPRNACan3DProMet_M2, na.rm = TRUE), "H", "L"))
merged_df_clinical2 = mutate(merged_df_clinical2, M2_DeconRNASeq = ifelse(DeconRNASeq_BPRNACan3DProMet_M2 > median(DeconRNASeq_BPRNACan3DProMet_M2, na.rm = TRUE), "H", "L"))
merged_df_clinical2 = mutate(merged_df_clinical2, M2_CBSX_BPRNACan = ifelse(CBSX_BPRNACan3DProMet_M2 > median(CBSX_BPRNACan3DProMet_M2, na.rm = TRUE), "H", "L"))
merged_df_clinical2 = mutate(merged_df_clinical2, M2_CBSX_LM22 = ifelse(CBSX_LM22_Macrophages_M2 > median(CBSX_LM22_Macrophages_M2, na.rm = TRUE), "H", "L"))

km_trt_fit <- survfit(Surv(time_to_event, death) ~ M2_Epidish, data=merged_df_clinical2)
# Test delle differenze tra le curve di sopravvivenza
surv_diff_result <- survdiff(Surv(time_to_event, death) ~ M2_Epidish, data = merged_df_clinical2)

# Estrazione del p-value
p_value <- 1 - pchisq(surv_diff_result$chisq, length(surv_diff_result$n) - 1)

if(p_value < 0.05) autoplot(km_trt_fit)
print(p_value)



km_trt_fit <- survfit(Surv(time_to_event, death) ~ M2_DeconRNASeq, data=merged_df_clinical2)
# Test delle differenze tra le curve di sopravvivenza
surv_diff_result <- survdiff(Surv(time_to_event, death) ~ M2_Epidish, data = merged_df_clinical2)

# Estrazione del p-value
p_value <- 1 - pchisq(surv_diff_result$chisq, length(surv_diff_result$n) - 1)

if(p_value < 0.05) autoplot(km_trt_fit)
print(p_value)




km_trt_fit <- survfit(Surv(time_to_event, death) ~ M2_CBSX_BPRNACan, data=merged_df_clinical2)
# Test delle differenze tra le curve di sopravvivenza
surv_diff_result <- survdiff(Surv(time_to_event, death) ~ M2_Epidish, data = merged_df_clinical2)

# Estrazione del p-value
p_value <- 1 - pchisq(surv_diff_result$chisq, length(surv_diff_result$n) - 1)

if(p_value < 0.05) autoplot(km_trt_fit)
print(p_value)



km_trt_fit <- survfit(Surv(time_to_event, death) ~ M2_CBSX_LM22, data=merged_df_clinical2)
# Test delle differenze tra le curve di sopravvivenza
surv_diff_result <- survdiff(Surv(time_to_event, death) ~ M2_Epidish, data = merged_df_clinical2)

# Estrazione del p-value
p_value <- 1 - pchisq(surv_diff_result$chisq, length(surv_diff_result$n) - 1)

# if(p_value < 0.05) 
autoplot(km_trt_fit)
print(p_value)


ggplot(merged_df_clinical2, aes(x=time_to_event, y=Epidish_BPRNACan3DProMet_M2)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE)

# long_df <- pivot_longer(merged_df_clinical, 
#                         cols = -death,                         
#                         names_to = "variable", 
#                         values_to = "value")

# ggplot(long_df, aes(x = variable, y = value, fill=death)) +
#   geom_violin() +
#   scale_y_continuous(limits = c(-0.0001, 0.0020)) + # Sostituisci ymin e ymax con i valori desiderati
#   theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

```

# Loading CellTFusion data
```{r CellTFusion Loading}
CellTFusion <- read.csv("/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/04_CellTFusion/Whitout_CD226_and_without_patient3/Deconvolution_after_subgrouping.csv", header = 1, row.names = 1)
```


# Benchmark of CellTFusion deconvolution results vs mIF data
```{r Correlation CellTFusion vs mIF}
# Computing correlation between CellTFusion Deconvolution features and imaging
corr_method <- "spearman"
imaging = "mIFs"
Deconv = "CellTFusion"
p_value_threshold <- 0.05 
low_corr <- -0.5
high_corr <- 0.5
output_folder_CellTFusion = "/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/04_CellTFusion/Whitout_CD226_and_without_patient3/Correlations/all_vs_all/"

corr_results <- compute_correlation(deconv_path = "/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/04_CellTFusion/Whitout_CD226_and_without_patient3/IF_CellTFusion_result/Deconvolution_after_subgrouping.csv",
                         imaging_path = "/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/01_IF_IMC/all_IFs_cell_type_fraction.csv",
                         imaging_pattern_to_remove = "-FIXT-01",
                         deconv_pattern_to_remove = "",
                         significance_level = p_value_threshold,
                         low_corr_threshold = low_corr,
                         high_corr_threshold = high_corr,
                         cor_type = corr_method,
                         imaging_type = imaging,
                         deconv_type = Deconv)

plot_correlation_matrix(high_corr_pairs = corr_results[[1]],
                        cor_type = corr_method,
                        file_name = paste(Deconv, "vs", imaging, sep = "_"),
                        output_folder = output_folder_CellTFusion,
                        save_png = T,
                        x_label = imaging,
                        y_label = Deconv,
                        significance_level = p_value_threshold,
                        high_corr_threshold = high_corr,
                        low_corr_threshold = low_corr,
                        png_width = 20,
                        png_height = 20
                        )


# Apri il dispositivo PDF
pdf(file = paste0(output_folder_CellTFusion, "scatterplot_", Deconv, "_vs_", imaging, ".pdf"))

for (i in 1:nrow(corr_results[[1]])) {
  # Imposta due plot per pagina
  if (i %% 2 == 1 || nrow(corr_results[[1]]) == 1) {  # Apre una nuova pagina se i è dispari o c'è solo un plot
    par(mfrow=c(2, 1))
  }

  # Seleziona i dati per il plot
  x <- dplyr::select(corr_results[[6]], corr_results[[1]][i, "Feature1"]) 
  y <- dplyr::select(corr_results[[6]], corr_results[[1]][i, "Feature2"]) 

  # Calcola il modello di regressione lineare e aggiungi la linea di regressione
  model <- lm(y[, 1] ~ x[, 1])
  # Calcola R^2 e aggiungi il testo al plot
  r <- summary(model)$r.squared
  # Crea il plot
  plot(x[, 1], y[, 1], 
       main = "Scatter Plot",
       xlab = corr_results[[1]][i, "Feature1"], 
       ylab = corr_results[[1]][i, "Feature2"], 
       cex.lab = 0.75)
  
  abline(model, col = "red")
  mtext(paste("R^2:", round(r, 2)), side = 3, line = 0.5, adj = 0)
  # Non chiudere il dispositivo dopo ogni plot
}

# Chiudi il dispositivo PDF dopo che tutti i plot sono stati generati
dev.off()
```

# Benchmark of CellTFusion deconvolution results vs IMC data
```{r Correlation CellTFusion vs IMC}
# Computing correlation between CellTFusion Deconvolution features and imaging
corr_method <- "spearman"
imaging = "IMC"
Deconv = "CellTFusion"
p_value_threshold <- 0.05 
low_corr <- -0.5
high_corr <- 0.5

corr_results <- compute_correlation(deconv_path = "/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/04_CellTFusion/Whitout_CD226_and_without_patient3/IMC_CellTFusion_result/Deconvolution_after_subgrouping.csv",
                         imaging_path = "/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/01_IF_IMC/IMC_cell_type_densities.csv",
                         imaging_pattern_to_remove = "",
                         deconv_pattern_to_remove = "",
                         significance_level = p_value_threshold,
                         low_corr_threshold = low_corr,
                         high_corr_threshold = high_corr,
                         cor_type = corr_method,
                         imaging_type = imaging,
                         deconv_type = Deconv)

plot_correlation_matrix(high_corr_pairs = corr_results[[1]],
                        cor_type = corr_method,
                        file_name = paste(Deconv, "vs", imaging, sep = "_"),
                        output_folder = output_folder_CellTFusion,
                        save_png = T,
                        x_label = imaging,
                        y_label = Deconv,
                        significance_level = p_value_threshold,
                        high_corr_threshold = high_corr,
                        low_corr_threshold = low_corr)


# Apri il dispositivo PDF
pdf(file = paste0(output_folder_CellTFusion, "scatterplot_", Deconv, "_vs_", imaging, ".pdf"))

for (i in 1:nrow(corr_results[[1]])) {
  # Imposta due plot per pagina
  if (i %% 2 == 1 || nrow(corr_results[[1]]) == 1) {  # Apre una nuova pagina se i è dispari o c'è solo un plot
    par(mfrow=c(2, 1))
  }

  # Seleziona i dati per il plot
  x <- dplyr::select(corr_results[[6]], corr_results[[1]][i, "Feature1"]) 
  y <- dplyr::select(corr_results[[6]], corr_results[[1]][i, "Feature2"]) 

  # Calcola il modello di regressione lineare e aggiungi la linea di regressione
  model <- lm(y[, 1] ~ x[, 1])
  # Calcola R^2 e aggiungi il testo al plot
  r <- summary(model)$r.squared
  # Crea il plot
  plot(x[, 1], y[, 1], 
       main = "Scatter Plot",
       xlab = corr_results[[1]][i, "Feature1"], 
       ylab = corr_results[[1]][i, "Feature2"], 
       cex.lab = 0.75)
  
  abline(model, col = "red")
  mtext(paste("R^2:", round(r, 2)), side = 3, line = 0.5, adj = 0)
  # Non chiudere il dispositivo dopo ogni plot
}

# Chiudi il dispositivo PDF dopo che tutti i plot sono stati generati
dev.off()

```

# Benchmark of mIFs vs IMC data
```{r Correlation mIFs vs IMC}
# loading mIF DENSITIES files and using the same patient names convention.  
IF1 <- read.csv("/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/01_IF_IMC/IF1_cell_type_densities.csv", header = 1, row.names = 1)
rownames(IF1) <- rownames(IF1) %>% 
  str_remove_all("-IF1-01")

IF2 <- read.csv("/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/01_IF_IMC/IF2_cell_type_densities.csv", header = 1, row.names = 1)
rownames(IF2) <- rownames(IF2) %>% 
  str_remove_all("-IF2-01")

IF3 <- read.csv("/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/01_IF_IMC/IF3_cell_type_densities.csv", header = 1, row.names = 1)
rownames(IF3) <- rownames(IF3) %>% 
  str_remove_all("-IF3-01")

# Keeping only common patients and saving the file
common_patients <- Reduce(intersect, list(rownames(IF1), rownames(IF2), rownames(IF3))) # Reduce because to apply intersect on more sets, you should reduce the common intersection progressively
IFs <- cbind(IF1[common_patients,], IF2[common_patients,], IF3[common_patients,])

# write.csv(IFs, "/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/01_IF_IMC/all_IFs_cell_type_densities.csv")

# Computing correlation between mIFs densities vs IMC densities
corr_method <- "spearman"
imaging = "IMC"
imaging2 = "mIFs"
p_value_threshold <- 0.05 
low_corr <- -0.5
high_corr <- 0.5

corr_results <- compute_correlation(deconv_path = "/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/01_IF_IMC/all_IFs_cell_type_densities.csv",
                         imaging_path = "/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/01_IF_IMC/IMC_cell_type_densities.csv",
                         imaging_pattern_to_remove = "",
                         deconv_pattern_to_remove = "-FIXT-01",
                         significance_level = p_value_threshold,
                         low_corr_threshold = low_corr,
                         high_corr_threshold = high_corr,
                         cor_type = corr_method,
                         imaging_type = imaging,
                         deconv_type = imaging2)

plot_correlation_matrix(high_corr_pairs = corr_results[[1]],
                        cor_type = corr_method,
                        file_name = paste(imaging2, "vs", imaging, sep = "_"),
                        output_folder = "/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/01_IF_IMC/",
                        save_png = T,
                        x_label = imaging,
                        y_label = imaging2,
                        significance_level = p_value_threshold,
                        high_corr_threshold = high_corr,
                        low_corr_threshold = low_corr)


# ggplot(a, aes(x=B_fraction, y=XCell_B_cell)) +
#   geom_point() +
#   geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE)

```

# TO DO
```{r}
 
# Analisi Risultati di deconvoluzione in termini di stackable histograms
# heatmap sui samples e PCA sulla deconvoluzione

# CellTFusion
```


# Saving file
```{r Saving file}
# Write file in the correct format for deconvolution
TPM <- rownames_to_column(TPM, "Genes") 
name <- "NSCLC2" 

write.table(TPM, file = paste0(output_folder, name,"_TPM.txt"), quote = F, sep = "\t", row.names = F)
message(paste0(output_folder, name,"_TPM.txt"))
```

# Correlation splitting by cell types Deconvolution IMC
```{r Correlation splitting by cell types IMC}
imaging_method = "IMC"
Deconv_method = "Deconv"
corr_method <- "spearman"

imaging = read.csv("/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/01_IF_IMC/IMC_cell_type_densities.csv", row.names = 1)
imaging = imaging[,-1]

imaging = imaging %>%
  rename("B" = "B.cells",
         "CD4" = "CD4.cells",
          "CD8" = "CD8.cells",
          "DC" = "Dendritic.cells",
          "MacCD163" = "Macrophages.M1",
          "NK" = "NK.cells",
          "Treg" = "T.cells.regulatory",
          "Tumor" = "Cancer",
          "plasma" = "Plasma")

source('~/CellTFusion/src/cell_deconvolution.R')

deconv = read.delim("/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/03_Deconvolution/Whitout_CD226_and_without_patient3/all_deconvolutions_NSCLC2_TPM_withoutCD226_withoutPatient3.txt", header = 1, row.names = 1)

rownames(deconv) <- str_remove_all(string = rownames(deconv), pattern = "-RNA-01|-RNA-02|-RNA-04|-FIXT-01")

common_patients <- intersect(rownames(deconv), rownames(imaging))

# Subset the data for common patients
imaging_common <- imaging[common_patients,]
deconv_common <- deconv[common_patients, ]

deconv_common.fixed = fix.names.GEMDeCan(deconv_common)
source('/home/francesco.massaini/Desktop/IMMUCAN_Internship_code/pseudobulk_function.R')

benchmarking_deconvolution(deconvolution = deconv_common.fixed, groundtruth = imaging_common, corr_type = corr_method, file_name = paste0("correlation_", Deconv_method, "_vs_", imaging_method, "_", corr_method), scatter = TRUE, imaging_type = imaging_method, coord_x = 1, coord_y = 1000)

```

# Correlation splitting by cell types Deconvolution IMC specific for Mural # TO DO
```{r Correlation splitting by cell types IMC}
imaging_method = "IMC"
Deconv_method = "Deconv"
corr_method <- "spearman"

imaging = read.csv("/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/01_IF_IMC/IMC_cell_type_densities.csv", row.names = 1)
imaging = select(imaging, Mural)

source('~/CellTFusion/src/cell_deconvolution.R')

deconv = read.delim("/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/03_Deconvolution/Whitout_CD226_and_without_patient3/all_deconvolutions_NSCLC2_TPM_withoutCD226_withoutPatient3.txt", header = 1, row.names = 1)

rownames(deconv) <- str_remove_all(string = rownames(deconv), pattern = "-RNA-01|-RNA-02|-RNA-04|-FIXT-01")

common_patients <- intersect(rownames(deconv), rownames(imaging))

# Subset the data for common patients
imaging_common <- imaging[common_patients,]
deconv_common <- deconv[common_patients, ]

deconv_common.fixed = fix.names.GEMDeCan(deconv_common)

IMC_Deconv <- cbind(deconv_common.fixed, imaging_common)

Mural_corr <- rcorr(y =deconv_common.fixed,x =imaging_common, type = "spearman")
View(Mural_corr$r)
# my_cor<-cor$r[c("hp","wt"),c("mpg","disp")]

```


# Correlation splitting by cell types CellTFusion IMC
```{r Correlation splitting by cell types IMC}
imaging_method = "IMC"
Deconv_method = "CellTFusion"
corr_method <- "spearman"
imaging = read.csv("/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/01_IF_IMC/IMC_cell_type_densities.csv", row.names = 1)
imaging = imaging[,-1]

load("/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/04_CellTFusion/Whitout_CD226_and_without_patient3/IMC_CellTFusion_result/CellTFusion_Subgroups.RData")
common_patients <- intersect(rownames(imaging), rownames(dt[[1]]))
imaging_common <- imaging[common_patients,]
# Correlation by cell types
correlation <- function(data, corr) {
  require(tidyr)
  M <- Hmisc::rcorr(as.matrix(data), type = corr)
  Mdf <- map(M, ~data.frame(.x))
  
  corr_df = Mdf %>%
    map(~rownames_to_column(.x, var="measure1")) %>%
    map(~pivot_longer(.x, -measure1, names_to = "measure2")) %>%
    bind_rows(.id = "id") %>%
    pivot_wider(names_from = id, values_from = value) %>%
    mutate(sig_p = ifelse(P < .05, T, F),
           p_if_sig = ifelse(sig_p, P, NA),
           r_if_sig = ifelse(sig_p, r, NA)) 
  
  return(corr_df)
  
}

dt_cell_types = dt[["Deconvolution groups per cell types"]]

for (i in names(dt_cell_types)) {
  imaging_common <- imaging[common_patients,]
  #imaging_common <- imaging_common[, c(i,setdiff(names(imaging_common), i))] 
  if(ncol(dt_cell_types[[i, drop = FALSE]]) != 0){
    
    df_corr_cell_type <- cbind(imaging_common, dt_cell_types[[i, drop = FALSE]])
    x <- correlation(df_corr_cell_type, corr = corr_method)
    x = filter(x, (measure1 %in% colnames(imaging_common) & measure2 %in% colnames(dt_cell_types[[i]]))) %>%# only taking ground vs deconv
      arrange(desc(r))
    
    pdf(paste0("../IMMUCAN_data/NSCLC2/04_CellTFusion/Whitout_CD226_and_without_patient3/Correlations/Splitting_celltype/IMC/", Deconv_method, "_", i ,"_vs_", imaging_method , "_", corr_method,".pdf"), width = 15)
    p = ggplot(data = x, aes(y = measure2, x = measure1, fill=r, label=round(r_if_sig,2))) +
      geom_tile() +
      labs(fill = paste0(corr_method, "'s\nCorrelation"), title = paste("Correlations", Deconv_method ,"Features vs", imaging_method),
             subtitle = paste0("Only significant ", corr_method, "'s correlation coefficients shown.")) +
      scale_fill_gradient2(mid="#FBFEF9",low="#0C6291",high="#A63446", limits=c(-1,1)) +
      geom_text() +
      theme_classic() +
      scale_x_discrete(expand=c(0,0)) +
      scale_y_discrete(expand=c(0,0)) +
      theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), axis.text.y = element_text(size = 10)) +
      xlab(imaging_method) + 
      ylab(Deconv_method)
    print(p)
    dev.off()
  }
}
```

# Correlation splitting by cell types CellTFusion mIFs
```{r Correlation splitting by cell types mIFs}
# IF1

imaging_method = "IF1"
Deconv_method = "CellTFusion"
corr_method <- "spearman"
imaging = read.csv("/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/01_IF_IMC/IF1_cell_type_fraction.csv", row.names = 1)
imaging = imaging[,-1]
rownames(imaging) <- str_remove_all(string = rownames(imaging), pattern = "-RNA-01|-RNA-02|-RNA-04|-FIXT-01|-IF1-01")


load("/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/04_CellTFusion/Whitout_CD226_and_without_patient3/IF_CellTFusion_result/CellTFusion_Subgroups.RData")
common_patients <- intersect(rownames(imaging), rownames(dt[[1]]))
imaging_common <- imaging[common_patients,]
# Correlation by cell types
correlation <- function(data, corr) {
  require(tidyr)
  M <- Hmisc::rcorr(as.matrix(data), type = corr)
  Mdf <- map(M, ~data.frame(.x))
  
  corr_df = Mdf %>%
    map(~rownames_to_column(.x, var="measure1")) %>%
    map(~pivot_longer(.x, -measure1, names_to = "measure2")) %>%
    bind_rows(.id = "id") %>%
    pivot_wider(names_from = id, values_from = value) %>%
    mutate(sig_p = ifelse(P < .05, T, F),
           p_if_sig = ifelse(sig_p, P, NA),
           r_if_sig = ifelse(sig_p, r, NA)) 
  
  return(corr_df)
  
}

dt_cell_types = dt[["Deconvolution groups per cell types"]]

for (i in names(dt_cell_types)) {
  imaging_common <- imaging[common_patients,]
  #imaging_common <- imaging_common[, c(i,setdiff(names(imaging_common), i))] 
  if(ncol(dt_cell_types[[i, drop = FALSE]]) != 0){
    
    df_corr_cell_type <- cbind(imaging_common, dt_cell_types[[i, drop = FALSE]])
    x <- correlation(df_corr_cell_type, corr = corr_method)
    x = filter(x, (measure1 %in% colnames(imaging_common) & measure2 %in% colnames(dt_cell_types[[i]]))) %>%# only taking ground vs deconv
      arrange(desc(r))
    
    pdf(paste0("../IMMUCAN_data/NSCLC2/04_CellTFusion/Whitout_CD226_and_without_patient3/Correlations/Splitting_celltype/IF1/", Deconv_method, "_", i ,"_vs_", imaging_method , "_", corr_method,".pdf"), width = 15)
    p = ggplot(data = x, aes(y = measure2, x = measure1, fill=r, label=round(r_if_sig,2))) +
      geom_tile() +
      labs(fill = paste0(corr_method, "'s\nCorrelation"), title = paste("Correlations", Deconv_method ,"Features vs", imaging_method),
             subtitle = paste0("Only significant ", corr_method, "'s correlation coefficients shown.")) +
      scale_fill_gradient2(mid="#FBFEF9",low="#0C6291",high="#A63446", limits=c(-1,1)) +
      geom_text() +
      theme_classic() +
      scale_x_discrete(expand=c(0,0)) +
      scale_y_discrete(expand=c(0,0)) +
      theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), axis.text.y = element_text(size = 10)) +
      xlab(imaging_method) + 
      ylab(Deconv_method)
    print(p)
    dev.off()
  }
}

# IF2
imaging_method = "IF2"
Deconv_method = "CellTFusion"
corr_method <- "spearman"
imaging = read.csv("/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/01_IF_IMC/IF2_cell_type_fraction.csv", row.names = 1)
imaging = imaging[,-1]
rownames(imaging) <- str_remove_all(string = rownames(imaging), pattern = "-RNA-01|-RNA-02|-RNA-04|-FIXT-01|-IF2-01")


load("/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/04_CellTFusion/Whitout_CD226_and_without_patient3/IF_CellTFusion_result/CellTFusion_Subgroups.RData")
common_patients <- intersect(rownames(imaging), rownames(dt[[1]]))
imaging_common <- imaging[common_patients,]
# Correlation by cell types
correlation <- function(data, corr) {
  require(tidyr)
  M <- Hmisc::rcorr(as.matrix(data), type = corr)
  Mdf <- map(M, ~data.frame(.x))
  
  corr_df = Mdf %>%
    map(~rownames_to_column(.x, var="measure1")) %>%
    map(~pivot_longer(.x, -measure1, names_to = "measure2")) %>%
    bind_rows(.id = "id") %>%
    pivot_wider(names_from = id, values_from = value) %>%
    mutate(sig_p = ifelse(P < .05, T, F),
           p_if_sig = ifelse(sig_p, P, NA),
           r_if_sig = ifelse(sig_p, r, NA)) 
  
  return(corr_df)
  
}

dt_cell_types = dt[["Deconvolution groups per cell types"]]

for (i in names(dt_cell_types)) {
  imaging_common <- imaging[common_patients,]
  #imaging_common <- imaging_common[, c(i,setdiff(names(imaging_common), i))] 
  if(ncol(dt_cell_types[[i, drop = FALSE]]) != 0){
    
    df_corr_cell_type <- cbind(imaging_common, dt_cell_types[[i, drop = FALSE]])
    x <- correlation(df_corr_cell_type, corr = corr_method)
    x = filter(x, (measure1 %in% colnames(imaging_common) & measure2 %in% colnames(dt_cell_types[[i]]))) %>%# only taking ground vs deconv
      arrange(desc(r))
    
    pdf(paste0("../IMMUCAN_data/NSCLC2/04_CellTFusion/Whitout_CD226_and_without_patient3/Correlations/Splitting_celltype/IF2/", Deconv_method, "_", i ,"_vs_", imaging_method , "_", corr_method,".pdf"), width = 15)
    p = ggplot(data = x, aes(y = measure2, x = measure1, fill=r, label=round(r_if_sig,2))) +
      geom_tile() +
      labs(fill = paste0(corr_method, "'s\nCorrelation"), title = paste("Correlations", Deconv_method ,"Features vs", imaging_method),
             subtitle = paste0("Only significant ", corr_method, "'s correlation coefficients shown.")) +
      scale_fill_gradient2(mid="#FBFEF9",low="#0C6291",high="#A63446", limits=c(-1,1)) +
      geom_text() +
      theme_classic() +
      scale_x_discrete(expand=c(0,0)) +
      scale_y_discrete(expand=c(0,0)) +
      theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), axis.text.y = element_text(size = 10)) +
      xlab(imaging_method) + 
      ylab(Deconv_method)
    print(p)
    dev.off()
  }
}

# IF3
imaging_method = "IF3"
Deconv_method = "CellTFusion"
corr_method <- "spearman"
imaging = read.csv("/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/01_IF_IMC/IF3_cell_type_fraction.csv", row.names = 1)
imaging = imaging[,-1]
rownames(imaging) <- str_remove_all(string = rownames(imaging), pattern = "-RNA-01|-RNA-02|-RNA-04|-FIXT-01|-IF3-01")


load("/home/francesco.massaini/Desktop/IMMUCAN_data/NSCLC2/04_CellTFusion/Whitout_CD226_and_without_patient3/IF_CellTFusion_result/CellTFusion_Subgroups.RData")
common_patients <- intersect(rownames(imaging), rownames(dt[[1]]))
imaging_common <- imaging[common_patients,]
# Correlation by cell types
correlation <- function(data, corr) {
  require(tidyr)
  M <- Hmisc::rcorr(as.matrix(data), type = corr)
  Mdf <- map(M, ~data.frame(.x))
  
  corr_df = Mdf %>%
    map(~rownames_to_column(.x, var="measure1")) %>%
    map(~pivot_longer(.x, -measure1, names_to = "measure2")) %>%
    bind_rows(.id = "id") %>%
    pivot_wider(names_from = id, values_from = value) %>%
    mutate(sig_p = ifelse(P < .05, T, F),
           p_if_sig = ifelse(sig_p, P, NA),
           r_if_sig = ifelse(sig_p, r, NA)) 
  
  return(corr_df)
  
}

dt_cell_types = dt[["Deconvolution groups per cell types"]]

for (i in names(dt_cell_types)) {
  imaging_common <- imaging[common_patients,]
  #imaging_common <- imaging_common[, c(i,setdiff(names(imaging_common), i))] 
  if(ncol(dt_cell_types[[i, drop = FALSE]]) != 0){
    
    df_corr_cell_type <- cbind(imaging_common, dt_cell_types[[i, drop = FALSE]])
    x <- correlation(df_corr_cell_type, corr = corr_method)
    x = filter(x, (measure1 %in% colnames(imaging_common) & measure2 %in% colnames(dt_cell_types[[i]]))) %>%# only taking ground vs deconv
      arrange(desc(r))
    
    pdf(paste0("../IMMUCAN_data/NSCLC2/04_CellTFusion/Whitout_CD226_and_without_patient3/Correlations/Splitting_celltype/IF3/", Deconv_method, "_", i ,"_vs_", imaging_method , "_", corr_method,".pdf"), width = 15)
    p = ggplot(data = x, aes(y = measure2, x = measure1, fill=r, label=round(r_if_sig,2))) +
      geom_tile() +
      labs(fill = paste0(corr_method, "'s\nCorrelation"), title = paste("Correlations", Deconv_method ,"Features vs", imaging_method),
             subtitle = paste0("Only significant ", corr_method, "'s correlation coefficients shown.")) +
      scale_fill_gradient2(mid="#FBFEF9",low="#0C6291",high="#A63446", limits=c(-1,1)) +
      geom_text() +
      theme_classic() +
      scale_x_discrete(expand=c(0,0)) +
      scale_y_discrete(expand=c(0,0)) +
      theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), axis.text.y = element_text(size = 10)) +
      xlab(imaging_method) + 
      ylab(Deconv_method)
    print(p)
    dev.off()
  }
}
```
